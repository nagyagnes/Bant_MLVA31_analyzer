Bootstrap: docker
From: debian:bullseye-slim

%labels
    Description "Container for R >=4.2.1, minimap2 >=2.17, samtools >=1.10, EMBOSS primersearch >=6.6.0.0, cutadapt >=3.2, seqtk >=1.3, BLAST+ >=2.10.1+, and Bant_MLVA31_analyzer."

%environment
    export PATH=/opt/minimap2:/opt/seqtk:/opt/EMBOSS:/opt/blast/bin:/opt/Bant_MLVA31_analyzer:/opt/:$PATH
    export R_HOME=/usr/lib/R

%post
    DEBIAN_FRONTEND="noninteractive"
    TZ="UTC"
    TZ="${TZ}"

    apt-get update && apt-get install -y \
        build-essential \
        wget \
        git \
        curl \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev \
        libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        cmake \
        python3 \
        python3-pip \
        unzip \
        autoconf \
        libncurses5-dev \
        libncursesw5-dev \
        libtool \
        pkg-config \
        gawk \
        procps \
        gfortran \
        gfortran-10 \
        libgfortran-10-dev \
        liblapack-dev \
        libblas-dev

    apt-get install -y locales
    sed -i 's/^# *\(en_US.UTF-8\)/\1/' /etc/locale.gen
    locale-gen
    
    apt-get install -y --no-install-recommends r-base
    
    # Install R packages permute and vegan
    wget http://cran.r-project.org/src/contrib/permute_0.9-8.tar.gz
    wget http://cran.r-project.org/src/contrib/Archive/vegan/vegan_2.6-4.tar.gz
    R CMD INSTALL permute_0.9-8.tar.gz
    R CMD INSTALL vegan_2.6-4.tar.gz

    # Install minimap2 >=2.17
    apt-get install -y minimap2

    # Install samtools >=1.10
    wget https://github.com/samtools/samtools/releases/download/1.10/samtools-1.10.tar.bz2
    tar xjf samtools-1.10.tar.bz2
    cd samtools-1.10
    ./configure --prefix=/usr/local
    make && make install
    cd /opt
    rm -rf samtools-1.10 samtools-1.10.tar.bz2

    # Install EMBOSS (for primersearch) >=6.6.0.0
    apt-get install -y emboss

    # Install cutadapt >=3.2
    python3 -m pip install --upgrade pip
    python3 -m pip install cutadapt==3.2

    # Install biopython
    python3 -m pip install biopython

    # Install edlib
    python3 -m pip install edlib

    # Install seqtk >=1.3
    git clone https://github.com/lh3/seqtk.git
    cd seqtk && git checkout v1.3 && make && cd ..

    # Install BLAST+ >=2.10.1+
    wget https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/2.10.1/ncbi-blast-2.10.1+-x64-linux.tar.gz
    tar -xzf ncbi-blast-2.10.1+-x64-linux.tar.gz
    mv ncbi-blast-2.10.1+/bin/* /opt/
    export PATH="/opt:$PATH"
    rm ncbi-blast-2.10.1+-x64-linux.tar.gz

    # Install Bant_MLVA31_analyzer
    ln -s /bin/bash /usr/bin/bash
    git clone https://github.com/nagyagnes/Bant_MLVA31_analyzer.git /opt/Bant_MLVA31_analyzer
    chmod +x /opt/Bant_MLVA31_analyzer/Bant_MLVA31_analyzer.sh

    export PATH="/opt/Bant_MLVA31_analyzer:$PATH"
    
    cd /opt/Bant_MLVA31_analyzer 
    ./download_create_blast_database.sh
    
%runscript
    exec "$@"
